# MPM-Dambreak

![License](https://img.shields.io/badge/license-MIT-blue.svg)

**MPM-Dambreak** is a fluid simulation implementation of the classic ''Dam Break'' scenario using the **Moving Least Squares Material Point Method (MLS-MPM)**. This project demonstrates the coupling of fluid dynamics with rigid boundaries using robust numerical schemes.


---

## 1. Introduction and How to Run

### Overview
This repository contains the source code for simulating a column of water collapsing under gravity and collides with a rigid body (the Dam Break problem). 

### How to Run

To run the simulations, follow the command-line instructions located at the bottom of each `.cpp` source file. These commands will generate particle data files (`.ply`).

Use **[ParaView](https://www.paraview.org/download/)** to visualize the results and watch the animation.

#### Example: Running on Windows
For instance, to run `dambreak_stationary_obstacle.cpp` on Windows, execute the following commands in your terminal:

```bash
# 1. Compile (ensure you have a C++ compiler like MinGW)
g++ dambreak_stationary_obstacle.cpp -o dambreak_stationary_obstacle.exe -std=c++14 -O3 -lgdi32 -fopenmp

# 2. Run the executable
.\dambreak_stationary_obstacle.exe
```
The generated `.ply` files will be saved in the `ply_stationary_obstacle` directory.

---

## 2. Brief Introduction to MLS-MPM
 



### Particle to Grid (P2G)  


In P2G step, we need to transfer mass and momentum of particles to grid nodes. The weight of particle $\mathbf{x}_p$ w.r.t grid node $\mathbf{x}_i$ is computed as 


$$
w_{ip} =: N_{i}(\mathbf{x}_p)=N(x)N(y)N(z)
$$

where $x,y,z$ are the normalized distances to $\mathbf{x}_i$ in each dimention, and $N$ is the quadratic kernel (***[The Material Point Method for Simulating
Continuum Materials](https://dl.acm.org/doi/pdf/10.1145/2897826.2927348?casa_token=q5jsi9S16bEAAAAA:sbCHMJKA3o7m2RrqBKSGUW20XpFLz_Qpa6fxxRTwjVvziraKjb9c8vZCBJvYBAsLz9BHvwdVqBAt3lg)***, Eq.(123))

$$
N(x) = \begin{cases} 
\frac{3}{4} - x^2 & |x| \in [0, \frac{1}{2}) \\
\frac{1}{2}(\frac{3}{2} - |x|)^2 & |x| \in [\frac{1}{2}, \frac{3}{2}) \\
0 & \text{otherwise}
\end{cases}
$$

which ensures that the particle only affects the surrounding $3 \times 3 \times 3$ grid nodes.



The particle mass are transfered to grid node $\mathbf{x}_i$ using 

$$
m_i = \sum_{p} w_{ip} m_p
$$

Momentum is transfered using 

$$
(m \mathbf{v})_{i}^{\text{APIC}} = \sum_p w_{ip} m_p \left( \mathbf{v}_p + \mathbf{C}_p (\mathbf{x}_i - \mathbf{x}_p) \right)
$$

where $\mathbf{C}_p$ is the affine velocity matrix. The process up to now is identical to **[APIC (Affine-Particle-In-Cell)](https://dl.acm.org/doi/10.1145/2766996)**.





### Grid Momentum Update


What's special about MLS-MPM takes place in the grid momentum update step

$$
(m\mathbf{v})_i^{\text{new}} = (m\mathbf{v})_i^{\text{old}} + \Delta t (\mathbf{f}_i + m_i\mathbf{g})
$$
 

Where $\mathbf{f}_i$ is the internal force acting on grid node $i$, i.e., elastic restoring force generated by deformation, and $m_i\mathbf{g}$ is gravity.


#### Traditional MPM

In traditional MPM, there are two equivalent ways of deriving expression for $\mathbf{f}_i$: from discretizing the weak form of momentum equation or as the negative gradient
of total potential energy.

The momentum equation (governing equation) in Eulerian view is given by

$$
\rho(\mathbf{x}, t) \frac{\mathrm{D}\mathbf{v}}{\mathrm{D}t} = \nabla \cdot \boldsymbol{\sigma} + \rho(\mathbf{x}, t) \mathbf{g}
$$

where $\boldsymbol{\sigma}$ is the Cauchy stress.


As in standard Finite Element Methods, the weak formulation of the governing equation is obtained through multiplying
the equation by a test function, integrating by parts, and applying boundary conditions. After some derivations, we can obtain the weak form of force balance in the Eulerian view

$$
\int_{\Omega^t} q_{\alpha}(\mathbf{x}, t)\rho(\mathbf{x}, t)a_{\alpha}(\mathbf{x}, t) \\, \mathrm{d}\mathbf{x} = \int_{\partial\Omega^t} q_{\alpha} t_{\alpha} \\, \mathrm{d}s(\mathbf{x}) - \int_{\Omega^t} q_{\alpha,\beta} \sigma_{\alpha\beta} \\, \mathrm{d}\mathbf{x}
$$

which holds for arbitrary $\mathbf{q}(\cdot, t) : \Omega^t \rightarrow \mathbb{R}^d$.





Next, we will discretize the weak form in time and space. For time discretization, we replace the acceleration $a_{\alpha}(\mathbf{x}, t^n)$ with $\frac{1}{\Delta t}(v_{\alpha}^{n+1}(\mathbf{x})-v_{\alpha}^{n}(\mathbf{x}))$. For space discretization, we replace $q_\alpha$, $v_\alpha^n$ and $v_\alpha^{n+1}$ with grid based interpolants as $q_\alpha(\mathbf{x}, t^n) = \sum_i q_{i\alpha}(t^n)N_i(\mathbf{x})$, $v_\alpha^n(\mathbf{x}) = \sum_j v_{j\alpha}^n N_j(\mathbf{x})$, and $v_\alpha^{n+1}(\mathbf{x}) = \sum_j v_{j\alpha}^{n+1} N_j(\mathbf{x})$, or $q_\alpha^n = q_{i\alpha}^n N_i$, $v_\alpha^n = v_{j\alpha}^n N_j$, and $v_\alpha^{n+1} = v_{j\alpha}^{n+1} N_j$.
 
After some derivations, the final discretization is obtained as 

$$
\frac{(mv)_{i\alpha}^{n+1} - (mv)_{i\alpha}^n}{\Delta t} = \int_{\partial \Omega^{t^n}} N_i(\mathbf{x}) t_\alpha(\mathbf{x}, t^n) \\, \mathrm{d}s(\mathbf{x}) - \int_{\Omega^{t^n}} N_{i,\beta}(\mathbf{x}) \sigma_{\alpha\beta}(\mathbf{x}, t^n) \\, \mathrm{d}\mathbf{x}
$$

Since the LHS is the change in momentum, the RHS is (approximately) the force. After plugging in the estimate of the stress
$\boldsymbol{\sigma}_p^n \approx \sigma(\mathbf{x}_p^n, t^n)$ at each particle $\mathbf{x}_p^n$, we have the expression for the $\alpha$-th component of force acting on grid node $i$

$$
f_{i\alpha}=-\int_{\Omega^{t^n}} N_{i,\beta}(\mathbf{x}) \sigma_{\alpha\beta}(\mathbf{x}, t^n) \\, \mathrm{d}\mathbf{x} \approx - \sum_p \sigma_{p_{\alpha\beta}}^n N_{i,\beta}(\mathbf{x}_p^n) V_p^n  
$$

In vector notation

$$
\mathbf{f}_i \approx - \sum_p V_p^n \boldsymbol{\sigma}_p^n \nabla N_i(\mathbf{x}_p^n)
$$




For alternative derivation of force expression, assume a deformation gradient based hyperelastic energy density. The total elastic potential energy is then

$$
e = \sum_p V_p^0 \Psi_p(\mathbf{F}_p),  
$$



Nodal elastic force is the negative gradient of the total potential energy evaluated at nodal positions. Using Equation $\mathbf{F}_p(\mathbf{x}) = \left( \mathbf{I} + \sum_i (\mathbf{x}_i - \mathbf{x}\_i^n)(\nabla w\_{ip}^n)^T \right) \mathbf{F}_p^n$, the MPM spatial discretization of the stress-based forces is given as

$$
\mathbf{f}_i(\mathbf{x}) = -\frac{\partial e}{\partial \mathbf{x}_i}(\mathbf{x}) = -\sum_p V_p^0 \left( \frac{\partial \Psi_p}{\partial \mathbf{F}}(\mathbf{F}_p(\mathbf{x})) \right) (\mathbf{F}_p^n)^T \nabla w_{ip}^n.  
$$


This is the force acting on grid node $i$ resulting from elastic stresses of its nearby particles.
In the case of Symplectic Euler, the force is easily written as

$$
\mathbf{f}_i^n = \mathbf{f}_i(\mathbf{x}_i^n) = -\sum_p V_p^0 \left( \frac{\partial \Psi_p}{\partial \mathbf{F}}(\mathbf{F}_p^n) \right) (\mathbf{F}_p^n)^T \nabla w_{ip}^n,
$$

which fully depends on the existing particle/grid weights and particle attributes. Alternatively, the force can also be written using the Cauchy stress,

$$
\mathbf{f}_i^n = \mathbf{f}_i(\mathbf{x}_i^n) = -\sum_p V_p^n \boldsymbol{\sigma}_p^n \nabla w_{ip}^n,  
$$

which coincides with the weak form derivation.





#### MLS-MPM



MLS-MPM uses MLS shape functions, instead of quadratic kernels in traditional MPM.  Under this setting, along with **hyperelasticity assumption**, $\mathbf{f}_i$ can be derived as (MLS-MPM paper, Eq.(18))

$$
\mathbf{f}_i = - \sum_p V_p^0 \left( \mathbf{M}_p^{-1} \mathbf{P}(\mathbf{F}_p) \mathbf{F}_p^T \right) (\mathbf{x}_i - \mathbf{x}_p) N_i(\mathbf{x}_p)
$$


where $V_p^0$ is particle initial volume, Moment Matrix $\mathbf{M}_p^{-1} = \frac{4}{(\Delta x)^2}\mathbf{I}$ when using quadratic $N_i(\mathbf{x})$ ($\Delta x$ is the grid spacing), and $\mathbf{P}$ is the First Piola-Kirchhoff stress. 





Now we combine the **APIC momentum** and the **impulse generated by forces** ($\Delta t \mathbf{f}_i$) to calculate the total momentum of the grid nodes (MLS-MPM paper, Eq.(26)):

$$
\begin{aligned}
(m\mathbf{v})_i^{\text{total}} &= (m\mathbf{v})_i^{\text{APIC}} + \Delta t \mathbf{f}_i \\
&= \sum_p w_{ip} [m_p \mathbf{v}_p + m_p \mathbf{C}_p (\mathbf{x}_i - \mathbf{x}_p)] - \sum_p w_{ip} [\Delta t V_p^0 \mathbf{M}_p^{-1} \mathbf{P} \mathbf{F}^T (\mathbf{x}_i - \mathbf{x}_p)] \\
&= \sum_p w_{ip} \left( m_p \mathbf{v}_p + \underbrace{[m_p \mathbf{C}_p - \Delta t V_p^0 \mathbf{M}_p^{-1} \mathbf{P} \mathbf{F}^T]}_{\text{defined as } \mathbf{Q}_p \text{ (``affine'' in code)}} (\mathbf{x}_i - \mathbf{x}_p) \right)
\end{aligned}
$$

 
 Note that this is **explicit time integration**, in contrast to **semi-implicit integration** in ***[A Material Point Method for Snow Simulation](https://dl.acm.org/doi/pdf/10.1145/2461912.2461948)***.

In code, we replaced First Piola-Kirchhoff stress with Cauchy stress using the relationship

$$
\boldsymbol{\sigma} = \frac{1}{J}\mathbf{P}(\mathbf{F}) \mathbf{F}^T, J = \det(\mathbf{F})
$$





### Grid to Particle (G2P)


Process of G2P is similar to P2G. For simplicity, here I will only discuss the update process of matrix $\mathbf{C}_p$.


Let's return to APIC method. The matrix $\mathbf{C}_p$ is in fact defined as:

$$
\mathbf{C}_p = \mathbf{B}_p \mathbf{D}_p^{-1}
$$

Where:
* $\mathbf{B}\_p=\sum_i w_{ip} \mathbf{\widetilde{v}}_i (\mathbf{x}_i - \mathbf{x}_p)^T$ is the weighted velocity moment, $\mathbf{\widetilde{v}}_i$ is the updated grid velocity.
* $\mathbf{D}\_p=\sum_i w_{ip} (\mathbf{x}_i - \mathbf{x}_p)(\mathbf{x}_i - \mathbf{x}_p)^T$ is the Moment Matrix.


When using quadratic interpolation, $\mathbf{D}_p$ takes a simple form: $\mathbf{D}_p = \frac{1}{4}(\Delta x)^2\mathbf{I}$ (APIC paper, page 6), i.e., ${\mathbf{D}}_p^{-1} = \frac{4}{(\Delta x)^2}\mathbf{I}$.



 
Thus, expression for $\mathbf{C}_p$ becomes



$$
\begin{aligned}
\mathbf{C}_p &= \left( \sum_i w_{ip} \mathbf{\widetilde{v}}_i (\mathbf{x}_i - \mathbf{x}_p)^T \right) \left( \frac{4}{(\Delta x)^2} \mathbf{I} \right) \\
&= \frac{4}{\Delta x} \sum_i w_{ip} \mathbf{\widetilde{v}}_i \frac{(\mathbf{x}_i - \mathbf{x}_p)^T}{\Delta x}
\end{aligned}
$$




For more details on MLS-MPM, please refer to the **[original paper](https://yuanming.taichi.graphics/publication/2018-mlsmpm/)** and **[code repository](https://github.com/yuanming-hu/taichi_mpm)**.
 

---

## 3. Equation of State for Water


### Equation of State

To simulate water as a weakly compressible fluid, we define its pressure-density relationship using an **Equation of State (EOS)**. Since we do not solve the expensive Poisson equation for pressure, we use **[Taitâ€“Murnaghan Equation of State](https://en.wikipedia.org/wiki/Tait_equation#Tait%E2%80%93Murnaghan_equation_of_state)**, which allows small density variations to generate pressure that resists compression.

The pressure $p$ for a particle is calculated as:

$$
p = K \left[  J^{-\gamma} - 1 \right]
$$

Where:
* $K$: The bulk modulus (controls incompressibility), set to $K=50.0$ in code.
* $J$: The determinant of the deformation gradient $\mathbf{F}$ ( $J = \det(\mathbf{F})$ ). It represents the **volume ratio** ( $J = \frac{V_{\text{current}}}{V_{\text{initial}}}$ ).
    * $J < 1$ indicates compression (density increases).
    * $J = 1$ indicates no volume change.
* $\gamma$: The stiffness parameter, set to $\gamma=7.0$ in code.

<!-- > **Implementation Note:** In the code, density $\rho$ is estimated based on the particle's deformation gradient $J$ (where $J = \det(\mathbf{F})$). -->


The Cauchy stress is modeled through the **[Linear stress constitutive equation](https://en.wikipedia.org/wiki/Navier%E2%80%93Stokes_equations#Compressible_flow)** (viscocity terms neglected for now)

$$
\boldsymbol{\sigma} = -p\mathbf{I}
$$

### Determinant Update
According to the continuity equation, the rate of change of volume is characterized by the **divergence** of the fluid velocity field $\mathbf{v}$ ($\nabla \cdot \mathbf{v}$) through the following equation:

$$
\frac{DJ}{Dt} = J(\nabla \cdot \mathbf{v})
$$

In APIC or MLS-MPM, the matrix `p.C` carried by the particle approximates the **Velocity Gradient**, denoted as $\nabla \mathbf{v}$.

$$
C \approx \nabla \mathbf{v} = \begin{bmatrix}
\frac{\partial v_x}{\partial x} & \frac{\partial v_x}{\partial y} & \frac{\partial v_x}{\partial z} \\
\frac{\partial v_y}{\partial x} & \frac{\partial v_y}{\partial y} & \frac{\partial v_y}{\partial z} \\
\frac{\partial v_z}{\partial x} & \frac{\partial v_z}{\partial y} & \frac{\partial v_z}{\partial z}
\end{bmatrix}
$$

This is because, if we know the velocity $\mathbf{v}(\mathbf{x}_p)$ at a particle $\mathbf{x}_p$ and want to find the velocity $\mathbf{v}(\mathbf{x}_i)$ at a nearby grid node $\mathbf{x}_i$ , we can perform a first-order Taylor expansion of the velocity field:

$$
\mathbf{v}(\mathbf{x}_i) \approx \mathbf{v}(\mathbf{x}_p) + \nabla \mathbf{v}(\mathbf{x}_p) \cdot (\mathbf{x}_i - \mathbf{x}_p)
$$

while in APIC, the local velocity represented by a particle at the grid node $\mathbf{x}_i$ is (APIC paper, Eq.(8))

$$
 \mathbf{v}(\mathbf{x}_p) + \mathbf{C}_p (\mathbf{x}_i - \mathbf{x}_p)
$$

Combining the two equations, we have that $C \approx \nabla \mathbf{v}$. Thus, divergence of the velocity field $\nabla \cdot \mathbf{v}$ is given by

$$
\nabla \cdot \mathbf{v} = \frac{\partial v_x}{\partial x} + \frac{\partial v_y}{\partial y} + \frac{\partial v_z}{\partial z} = \text{Trace}(C)
$$

Use the first-order Taylor expansion to discretize the time derivative $\frac{DJ}{Dt}$:

$$
J_{n+1} \approx J_n + \Delta t \cdot \frac{DJ}{Dt}
$$

Substituting $\frac{DJ}{Dt} = J(\nabla \cdot \mathbf{v})$:

$$
\begin{aligned}
J_{n+1} &\approx J_n + \Delta t \cdot (J_n \cdot \nabla \cdot \mathbf{v}) \\
&= J_n \cdot (1 + \Delta t \cdot \nabla \cdot \mathbf{v}) \\
&= J_n \cdot (1 + \Delta t \cdot \text{Trace}(C))
\end{aligned}
$$



---

## 4. Coulomb Friction Model

To handle the interaction between the water and the rigid body, we implement a **Coulomb Friction model** in the grid update process.


First, compute the relative velocity of grid node w.r.t rigid body (obstacle)

$$
\mathbf{v}_{\text{rel}} = \mathbf{v}_{\text{grid}} - \mathbf{v}_{\text{obs}}
$$


The normal component of relative velocity is given by

$$
n = \mathbf{v}_{\text{rel}} \cdot \mathbf{v}_{\text{normal}}
$$

where $\mathbf{v}_{\text{normal}}$ is the surface normal vector.

If $n < 0$, then fluid is moving into the obstacle, we can thus compute tangential velocity and alter its value


$$
\mathbf{v}_{t} = \mathbf{v}_{\text{rel}} - \mathbf{v}_{\text{normal}} \cdot n, \mathbf{v}_{\text{new\\_rel}} = \mathbf{v}_{t} \cdot \mu
$$

where $\mu = 0$ stands for complete sticky, and $\mu = 1$ stands for complete slippery. We set $\mu = 0.5$ in code.

Finally, covert back to world velocity

$$
\mathbf{v}_{\text{new}} = \mathbf{v}_{\text{new\\_rel}} + \mathbf{v}_{\text{obs}}
$$

 

---
