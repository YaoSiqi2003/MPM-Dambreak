# MPM-Dambreak

![License](https://img.shields.io/badge/license-MIT-blue.svg)

**MPM-Dambreak** is a fluid simulation implementation of the classic ''Dam Break'' scenario using the **Moving Least Squares Material Point Method (MLS-MPM)**. This project demonstrates the coupling of fluid dynamics with rigid boundaries using robust numerical schemes.


---

## 1. Introduction and How to Run

### Overview
This repository contains the source code for simulating a column of water collapsing under gravity and collides with a rigid body (the Dam Break problem). 

### How to Run

To run the simulations, follow the command-line instructions located at the bottom of each `.cpp` source file. These commands will generate particle data files (`.ply`).

Use **[ParaView](https://www.paraview.org/download/)** to visualize the results and watch the animation.

#### Example: Running on Windows
For instance, to run `dambreak_stationary_obstacle.cpp` on Windows, execute the following commands in your terminal:

```bash
# 1. Compile (ensure you have a C++ compiler like MinGW)
g++ dambreak_stationary_obstacle.cpp -o dambreak_stationary_obstacle.exe -std=c++14 -O3 -lgdi32 -fopenmp

# 2. Run the executable
.\dambreak_stationary_obstacle.exe
```
The generated `.ply` files will be saved in the `ply_stationary_obstacle` directory.

---

## 2. Brief Introduction to MLS-MPM
 



### Particle to Grid (P2G)  


In P2G step, we need to transfer mass and momentum of particles to grid nodes. The weight of particle $\mathbf{x}_p$ w.r.t grid node $\mathbf{x}_i$ is computed as 


$$
w_{ip} =: N_{i}(\mathbf{x}_p)=N(x)N(y)N(z)
$$

where $x,y,z$ are the normalized distances to $\mathbf{x}_i$ in each dimention, and $N$ is the Quadratic B-spline function

$$
N(x) = \begin{cases} 
\frac{3}{4} - x^2 & |x| \in [0, \frac{1}{2}) \\
\frac{1}{2}(\frac{3}{2} - |x|)^2 & |x| \in [\frac{1}{2}, \frac{3}{2}) \\
0 & \text{otherwise}
\end{cases}
$$

which ensures that the particle only affects the surrounding $3 \times 3 \times 3$ grid nodes.



The particle mass are transfered to grid node $\mathbf{x}_i$ using 

$$
m_i = \sum_{p} w_{ip} m_p
$$

Momentum is transfered using 

$$
(m \mathbf{v})_{i}^{\text{APIC}} = \sum_p w_{ip} m_p \left( \mathbf{v}_p + \mathbf{C}_p (\mathbf{x}_i - \mathbf{x}_p) \right)
$$

where $\mathbf{C}_p$ is the affine velocity matrix. The process up to now is identical to **[APIC (Affine-Particle-In-Cell)](https://dl.acm.org/doi/10.1145/2766996)**.






### Grid Momentum Update


What's special about MLS-MPM takes place in the grid momentum update step

$$
(m\mathbf{v})_i^{\text{new}} = (m\mathbf{v})_i^{\text{old}} + \Delta t \mathbf{f}_i
$$
 

The paper showed that, under **hyperelasticity assumption**, $\mathbf{f}_i$ can be expressed as (MLS-MPM paper, Eq.(18))


$$
\mathbf{f}_i = - \sum_p V_p^0 \left( \mathbf{M}_p^{-1} \mathbf{P}(\mathbf{F}_p) \mathbf{F}_p^T \right) (\mathbf{x}_i - \mathbf{x}_p) N_i(\mathbf{x}_p)
$$


where $V_p^0$ is particle initial volume, Moment Matrix $\mathbf{M}_p^{-1} = \frac{4}{(\Delta x)^2}\mathbf{I}$ when using quadratic $N_i(\mathbf{x})$ ($\Delta x$ is the grid spacing), and $\mathbf{P}$ is the First Piola-Kirchhoff stress. 





Now we combine the **APIC momentum** and the **impulse generated by forces** ($\Delta t \mathbf{f}_i$) to calculate the total momentum of the grid nodes (MLS-MPM paper, Eq.(26)):

$$
\begin{aligned}
(m\mathbf{v})_i^{\text{total}} &= (m\mathbf{v})_i^{\text{APIC}} + \Delta t \mathbf{f}_i \\
&= \sum_p w_{ip} [m_p \mathbf{v}_p + m_p \mathbf{C}_p (\mathbf{x}_i - \mathbf{x}_p)] - \sum_p w_{ip} [\Delta t V_p^0 \mathbf{M}_p^{-1} \mathbf{P} \mathbf{F}^T (\mathbf{x}_i - \mathbf{x}_p)] \\
&= \sum_p w_{ip} \left( m_p \mathbf{v}_p + \underbrace{[m_p \mathbf{C}_p - \Delta t V_p^0 \mathbf{M}_p^{-1} \mathbf{P} \mathbf{F}^T]}_{\text{defined as } \mathbf{Q}_p \text{ (``affine'' in code)}} (\mathbf{x}_i - \mathbf{x}_p) \right)
\end{aligned}
$$

 
 


In code, we replaced First Piola-Kirchhoff stress with Cauchy stress using the relationship

$$
\mathbf{\sigma} = \frac{1}{J}\mathbf{P}(\mathbf{F}) \mathbf{F}^T, J = \det(\mathbf{F})
$$





### Grid to Particle (G2P)


Process of G2P is similar to P2G. For simplicity, here I will only discuss the update process of matrix $\mathbf{C}_p$.


Let's return to APIC method. The matrix $\mathbf{C}_p$ is in fact defined as:

$$
\mathbf{C}_p = \mathbf{B}_p \mathbf{D}_p^{-1}
$$

Where:
* $\mathbf{B}\_p=\sum_i w_{ip} \mathbf{\widetilde{v}}_i (\mathbf{x}_i - \mathbf{x}_p)^T$ is the weighted velocity moment, $\mathbf{\widetilde{v}}_i$ is the updated grid velocity.
* $\mathbf{D}\_p=\sum_i w_{ip} (\mathbf{x}_i - \mathbf{x}_p)(\mathbf{x}_i - \mathbf{x}_p)^T$ is the Moment Matrix.


When using quadratic interpolation, $\mathbf{D}_p$ takes a simple form: $\mathbf{D}_p = \frac{1}{4}(\Delta x)^2\mathbf{I}$ (APIC paper, page 6), i.e., ${\mathbf{D}}_p^{-1} = \frac{4}{(\Delta x)^2}\mathbf{I}$.



 
Thus, expression for $\mathbf{C}_p$ becomes



$$
\begin{aligned}
\mathbf{C}_p &= \left( \sum_i w_{ip} \mathbf{\widetilde{v}}_i (\mathbf{x}_i - \mathbf{x}_p)^T \right) \left( \frac{4}{(\Delta x)^2} \mathbf{I} \right) \\
&= \frac{4}{\Delta x} \sum_i w_{ip} \mathbf{\widetilde{v}}_i \frac{(\mathbf{x}_i - \mathbf{x}_p)^T}{\Delta x}
\end{aligned}
$$




For more details on MLS-MPM, please refer to the **[original paper](https://yuanming.taichi.graphics/publication/2018-mlsmpm/)** and **[code repository](https://github.com/yuanming-hu/taichi_mpm)**.
 

---

## 3. Equation of State for Water


### Equation of State

To simulate water as a weakly compressible fluid, we define its pressure-density relationship using an **Equation of State (EOS)**. Since we do not solve the expensive Poisson equation for pressure, we use **[Taitâ€“Murnaghan Equation of State](https://en.wikipedia.org/wiki/Tait_equation#Tait%E2%80%93Murnaghan_equation_of_state)**, which allows small density variations to generate pressure that resists compression.

The pressure $p$ for a particle is calculated as:

$$
p = K \left[  J^{-\gamma} - 1 \right]
$$

Where:
* $K$: The bulk modulus (controls incompressibility), set to $K=50.0$ in code.
* $J$: The determinant of the deformation gradient $\mathbf{F}$ ( $J = \det(\mathbf{F})$ ). It represents the **volume ratio** ( $J = \frac{V_{\text{current}}}{V_{\text{initial}}}$ ).
    * $J < 1$ indicates compression (density increases).
    * $J = 1$ indicates no volume change.
* $\gamma$: The stiffness parameter, set to $\gamma=7.0$ in code.

<!-- > **Implementation Note:** In the code, density $\rho$ is estimated based on the particle's deformation gradient $J$ (where $J = \det(\mathbf{F})$). -->


The Cauchy stress is modeled through the **[Linear stress constitutive equation](https://en.wikipedia.org/wiki/Navier%E2%80%93Stokes_equations#Compressible_flow)** (viscocity terms neglected for now)

$$
\mathbf{\sigma} = -p\mathbf{I}
$$

### Determinant Update
According to the continuity equation, the rate of change of volume is characterized by the **divergence** of the fluid velocity field $\mathbf{v}$ ($\nabla \cdot \mathbf{v}$) through the following equation:

$$
\frac{DJ}{Dt} = J(\nabla \cdot \mathbf{v})
$$

In APIC or MLS-MPM, the matrix `p.C` carried by the particle approximates the **Velocity Gradient**, denoted as $\nabla \mathbf{v}$.

$$
C \approx \nabla \mathbf{v} = \begin{bmatrix}
\frac{\partial v_x}{\partial x} & \frac{\partial v_x}{\partial y} & \frac{\partial v_x}{\partial z} \\
\frac{\partial v_y}{\partial x} & \frac{\partial v_y}{\partial y} & \frac{\partial v_y}{\partial z} \\
\frac{\partial v_z}{\partial x} & \frac{\partial v_z}{\partial y} & \frac{\partial v_z}{\partial z}
\end{bmatrix}
$$

This is because, if we know the velocity $\mathbf{v}(\mathbf{x}_p)$ at a particle $\mathbf{x}_p$ and want to find the velocity $\mathbf{v}(\mathbf{x}_i)$ at a nearby grid node $\mathbf{x}_i$ , we can perform a first-order Taylor expansion of the velocity field:

$$
\mathbf{v}(\mathbf{x}_i) \approx \mathbf{v}(\mathbf{x}_p) + \nabla \mathbf{v}(\mathbf{x}_p) \cdot (\mathbf{x}_i - \mathbf{x}_p)
$$

while in APIC, the local velocity represented by a particle at the grid node $\mathbf{x}_i$ is (APIC paper, Eq.(8))

$$
 \mathbf{v}(\mathbf{x}_p) + \mathbf{C}_p (\mathbf{x}_i - \mathbf{x}_p)
$$

Combining the two equations, we have that $C \approx \nabla \mathbf{v}$. Thus, divergence of the velocity field $\nabla \cdot \mathbf{v}$ is given by

$$
\nabla \cdot \mathbf{v} = \frac{\partial v_x}{\partial x} + \frac{\partial v_y}{\partial y} + \frac{\partial v_z}{\partial z} = \text{Trace}(C)
$$

Use the first-order Taylor expansion to discretize the time derivative $\frac{DJ}{Dt}$:

$$
J_{n+1} \approx J_n + \Delta t \cdot \frac{DJ}{Dt}
$$

Substituting $\frac{DJ}{Dt} = J(\nabla \cdot \mathbf{v})$:

$$
\begin{aligned}
J_{n+1} &\approx J_n + \Delta t \cdot (J_n \cdot \nabla \cdot \mathbf{v}) \\
&= J_n \cdot (1 + \Delta t \cdot \nabla \cdot \mathbf{v}) \\
&= J_n \cdot (1 + \Delta t \cdot \text{Trace}(C))
\end{aligned}
$$



---

## 4. Coulomb Friction Model

To handle the interaction between the water and the rigid body, we implement a **Coulomb Friction model** in the grid update process.


First, compute the relative velocity of grid node w.r.t rigid body (obstacle)

$$
\mathbf{v}_{\text{rel}} = \mathbf{v}_{\text{grid}} - \mathbf{v}_{\text{obs}}
$$


The normal component of relative velocity is given by

$$
n = \mathbf{v}_{\text{rel}} \cdot \mathbf{v}_{\text{normal}}
$$

where $\mathbf{v}_{\text{normal}}$ is the surface normal vector.

If $n < 0$, then fluid is moving into the obstacle, we can thus compute tangential velocity and alter its value


$$
\mathbf{v}_{t} = \mathbf{v}_{\text{rel}} - \mathbf{v}_{\text{normal}} \cdot n, \mathbf{v}_{\text{new\\_rel}} = \mathbf{v}_{t} \cdot \mu
$$

where $\mu = 0$ stands for complete sticky, and $\mu = 1$ stands for complete slippery. We set $\mu = 0.5$ in code.

Finally, covert back to world velocity

$$
\mathbf{v}_{\text{new}} = \mathbf{v}_{\text{new\\_rel}} + \mathbf{v}_{\text{obs}}
$$

 

---
